<script>
  const qs=(s,r=document)=>r.querySelector(s);
  const qsa=(s,r=document)=>[...r.querySelectorAll(s)];

  /* ====== Page refs ====== */
  const pages={
    selectFirst:qs('#selectShopPage'),
    home:qs('#homePage'),
    login:qs('#loginPage'),
    register:qs('#registerPage'),
    ongoing:qs('#ongoingPage')
  };
  const quickBar=qs('#quickBar');
  const currentShopLabel=qs('#currentShopLabel');

  /* ====== Constants ====== */
  const READY_SHOP='Computer Accessories Shop'; // main ready shop
  const ALL_SHOPS=[
    'Computer Accessories Shop',
    'Electrical Shop',
    'Electronics Shop',
    'Clothing Shop',
    'Jewellery Shop',
    'Grocery Shop',
    'Others'
  ];

  /* ====== Helpers for URL routing ====== */
  function encodeShop(name){ return encodeURIComponent(name); }
  function decodeShop(v){ if(!v) return null; try{ return decodeURIComponent(v.replace(/\+/g,' ')); }catch{ return v.replace(/\+/g,' ');} }

  // read `?shop=` from current URL
  function readShopFromURL(){
    const sp=new URLSearchParams(location.search);
    const val=sp.get('shop');
    return decodeShop(val);
  }

  // navigate to a shop by changing URL (works on GitHub Pages)
  function navigateToShop(name){
    if(!name) return;
    // keep it simple for GitHub Pages root
    location.href='/?shop='+encodeShop(name);
  }

  /* ====== Page show utilities ====== */
  function showPage(key){
    Object.values(pages).forEach(p=>p.classList.remove('show'));
    pages[key].classList.add('show');
    window.scrollTo({top:0,behavior:'auto'});
  }

  function setMenuBarVisible(v){ v?quickBar.classList.remove('hidden'):quickBar.classList.add('hidden'); }

  function paintOngoing(title){
    const label=title||'Shop';
    qs('#ongoingTitle').textContent=label;
    qs('#ongoingCrumb').textContent=label;
    qs('#ongoingText').textContent=`The work on The ${label} is ongoing.`;
  }

  /* ====== Routing core ====== */
  function routeFromURL(){
    const shop=readShopFromURL();
    if(!shop){
      currentShopLabel.textContent='Select Your Shop';
      setMenuBarVisible(false);
      showPage('selectFirst');
      return;
    }

    currentShopLabel.textContent=shop;
    const isReady=shop===READY_SHOP;

    if(isReady){
      setMenuBarVisible(true);
      showPage('home');
    }else{
      setMenuBarVisible(false);
      paintOngoing(shop);
      showPage('ongoing');
    }
  }

  /* ====== Header: Shop dropdown (open/close) ====== */
  const shopWrap=qs('#shopWrap'),shopBtn=qs('#shopBtn'),shopMenu=qs('#shopMenu');
  function openMenu(){shopBtn.setAttribute('aria-expanded','true');shopMenu.classList.add('open')}
  function closeMenu(){shopBtn.setAttribute('aria-expanded','false');shopMenu.classList.remove('open')}
  shopBtn.addEventListener('click',e=>{e.stopPropagation();shopMenu.classList.toggle('open');shopBtn.setAttribute('aria-expanded',shopMenu.classList.contains('open'))});
  shopWrap.addEventListener('mouseenter',openMenu);
  shopWrap.addEventListener('mouseleave',closeMenu);
  document.addEventListener('click', e=>{ if(!shopWrap.contains(e.target)) closeMenu(); });

  // pick a shop from dropdown -> go via URL (?shop=...)
  shopMenu.addEventListener('click',e=>{
    const li=e.target.closest('li'); if(!li) return;
    const name=li.getAttribute('data-value');
    closeMenu();
    navigateToShop(name);
  });

  // “A2Z logo/Home” → go to default “Select a shop” screen
  qs('#homeLink').addEventListener('click', (e)=>{
    e.preventDefault();
    location.href='/?';
  });

  // Quick bar Home icon → stay on current shop from URL
  qs('#navHome').addEventListener('click', (e)=>{ e.preventDefault(); routeFromURL(); });

  /* ====== Drawer ====== */
  const overlay=qs('#overlay'),drawer=qs('#drawer'),cartBtn=qs('#cartBtn');
  function openDrawer(){overlay.classList.add('show');drawer.classList.add('open');document.body.style.overflow='hidden'}
  function closeDrawer(){overlay.classList.remove('show');drawer.classList.remove('open');document.body.style.overflow=''}
  cartBtn.addEventListener('click',e=>{e.preventDefault();drawer.classList.contains('open')?closeDrawer():openDrawer();});
  qs('#drawerClose').addEventListener('click',closeDrawer); overlay.addEventListener('click',closeDrawer);
  qs('#viewCartFromDrawer').addEventListener('click',()=>{ closeDrawer(); });

  /* ====== Search (kept same but shops now navigate via URL) ====== */
  const searchBox = qs("#searchBox");
  const searchBtn = qs("#searchBtn");
  const sr = qs("#searchResults");
  const SEARCH_ITEMS = [
    { id:'shop-computer',   label:'Computer Accessories Shop — Home', icon:'fa-store', type:'shop', value:'Computer Accessories Shop' },
    { id:'shop-electrical', label:'Electrical Shop',  icon:'fa-store', type:'shop', value:'Electrical Shop' },
    { id:'shop-electronics',label:'Electronics Shop', icon:'fa-store', type:'shop', value:'Electronics Shop' },
    { id:'shop-cloth',      label:'Clothing Shop',    icon:'fa-store', type:'shop', value:'Clothing Shop' },
    { id:'shop-jewel',      label:'Jewellery Shop',   icon:'fa-store', type:'shop', value:'Jewellery Shop' },
    { id:'shop-grocery',    label:'Grocery Shop',     icon:'fa-store', type:'shop', value:'Grocery Shop' },
    { id:'shop-others',     label:'Others',           icon:'fa-store', type:'shop', value:'Others' },
    // sample categories below (still routes to ongoing)
    { id:'cat-drone', label:'Drone', icon:'fa-tags', type:'category' },
    { id:'cat-gimbal', label:'Gimbal', icon:'fa-tags', type:'category' },
    // … (বাকি item গুলো চাইলে রেখে দাও)
  ];

  function renderResults(list){
    if(!list.length){
      sr.innerHTML = `<div class="sr-empty">No results found</div>`;
      sr.classList.add('show'); return;
    }
    const shops = list.filter(i=>i.type==='shop');
    const cats  = list.filter(i=>i.type==='category');
    const sec = (title, items)=>`
      <div class="sr-section">
        <div class="sr-title">${title}</div>
        <ul class="sr-list">
          ${items.map((it,idx)=>`
            <li class="sr-item${idx===0&&title==='Shops'?' active':''}" data-id="${it.id}">
              <i class="fa ${it.icon}"></i><span>${it.label}</span>
            </li>`).join('')}
        </ul>
      </div>`;
    sr.innerHTML = `${shops.length?sec('Shops',shops):''}${cats.length?sec('Products',cats):''}`;
    sr.classList.add('show');
  }
  function filterResults(q){
    const term = q.trim().toLowerCase();
    if(!term){ renderResults(SEARCH_ITEMS); return; }
    renderResults(SEARCH_ITEMS.filter(it=> it.label.toLowerCase().includes(term)));
  }
  function openAllResults(){ renderResults(SEARCH_ITEMS); }
  function closeResults(){ sr.classList.remove('show'); }

  function pickItemById(id){
    const item = SEARCH_ITEMS.find(x=>x.id===id);
    if(!item) return;
    if(item.type==='shop'){
      navigateToShop(item.value); // << URL-এর মাধ্যমে নেভিগেশন
    }else{
      // category -> ongoing page (no URL change)
      paintOngoing(item.label); showPage('ongoing');
    }
    closeResults();
  }

  searchBox.addEventListener('focus', openAllResults);
  searchBox.addEventListener('click', openAllResults);
  searchBox.addEventListener('input', (e)=> filterResults(e.target.value));
  sr.addEventListener('click', (e)=>{
    const li = e.target.closest('.sr-item'); if(!li) return;
    pickItemById(li.getAttribute('data-id'));
  });
  searchBox.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){ e.preventDefault(); if(!sr.classList.contains('show')) openAllResults();
      const first = sr.querySelector('.sr-item'); if(first) pickItemById(first.getAttribute('data-id')); }
  });
  // ↑/↓ active move (optional)
  searchBox.addEventListener('keydown', (e)=>{
    if(!sr.classList.contains('show')) return;
    if(e.key==='ArrowDown' || e.key==='ArrowUp'){
      e.preventDefault();
      const items = qsa('.sr-item', sr);
      if(!items.length) return;
      let idx = items.findIndex(el=>el.classList.contains('active'));
      items.forEach(el=>el.classList.remove('active'));
      idx = e.key==='ArrowDown' ? (idx+1)%items.length : (idx-1+items.length)%items.length;
      items[idx].classList.add('active'); items[idx].scrollIntoView({block:'nearest'});
    }
  });
  searchBtn.addEventListener('click', (e)=>{
    e.preventDefault(); if(!sr.classList.contains('show')) openAllResults();
    const first = sr.querySelector('.sr-item'); if(first) pickItemById(first.getAttribute('data-id'));
  });
  document.addEventListener('click', (e)=>{ if(!qs('.searchbar').contains(e.target)) closeResults(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeResults(); });

  // prevent featured card default jumps
  qsa('.fc-item').forEach(a=>a.addEventListener('click',e=>e.preventDefault()));

  /* ====== Banner slider (unchanged – your images can stay) ====== */
  (function(){
    const imgs=[
      'https://img.pikbest.com/origin/10/01/82/867pIkbEsTAIq.png!sw800',
      'https://www.shutterstock.com/image-vector/ecommerce-website-banner-template-presents-260nw-2252124451.jpg',
      'https://static.vecteezy.com/system/resources/previews/002/006/774/non_2x/paper-art-shopping-online-on-smartphone-and-new-buy-sale-promotion-backgroud-for-banner-market-ecommerce-free-vector.jpg'
    ];
    const track=qs('#hbTrack'); track.innerHTML='';
    imgs.forEach(src=>{
      const a=document.createElement('a'); a.className='hb-slide'; a.href='#';
      a.innerHTML=`<img src="${src}" alt="">`; track.appendChild(a);
    });
    qs('#hbRightTop img').src='https://www.startech.com.bd/image/catalog/home/job-career-2024.webp';
    qs('#hbRightBottom img').src='https://t4.ftcdn.net/jpg/06/40/64/53/360_F_640645306_ADDT2XPJVYKhd1tIkqZF2vK1MZX4aSb3.jpg';

    const slider=qs('#hbSlider'),prev=qs('#hbPrev'),next=qs('#hbNext');
    const total=imgs.length; let idx=0, timer=null;
    function go(i){ idx=(i+total)%total; track.style.transform=`translateX(-${idx*100}%)`; }
    function start(){ stop(); timer=setInterval(()=>go(idx+1),3000); }
    function stop(){ if(timer){clearInterval(timer); timer=null;} }
    prev.addEventListener('click',()=>{go(idx-1); start();});
    next.addEventListener('click',()=>{go(idx+1); start();});
    slider.addEventListener('mouseenter',stop);
    slider.addEventListener('mouseleave',start);
    go(0); start();
  })();

  /* ====== Auth demo buttons (noop) ====== */
  qs('#loginBtn')?.addEventListener('click',()=>{});
  qs('#registerBtn')?.addEventListener('click',()=>{});

  /* ====== Initial route from URL ====== */
  routeFromURL();
</script>
